# Лабораторна робота №4. Робота з платформою Ubidots 

Для виконання завдань лабораторного заняття слід підготувати дані для надсилання. Як об'єкт контролю буде використовуватися імітаційна модель кондиціювання, реалізована на OPC UA сервері. 

### 4.0. Інсталяція та перевірка тестового OPC UA сервера та клієнта

Даний пункт необхідно виконувати, якщо не виконувалась лабораторна робота по OPC.

- [ ] Інсталюйте тестовий [OPC UA C++ Demo Server](https://www.unified-automation.com/downloads/opc-ua-servers.html) , якщо ще не інстальовано
- [ ] Інсталюйте тестовий OPC UA Client [UaExpert](https://www.unified-automation.com/downloads/opc-ua-clients.html), якщо ще не інстальовано
- [ ] Запустіть OPC UA C++ Demo Server та OPC UA Client, з'єднайте їх та перевірте взаємодію
- [ ] Інсталюйте модуль node-red-contrib-opcua, якщо він ще не інстальовано

### 4.0. Імпорт та перевірка роботи потоку для збору даних

- [ ] на локальному ПК запустіть Node-RED
- [ ] створіть новий проект
- [ ] скачайте [файл експорту потока](https://drive.google.com/file/d/1sG11-TY4EOX3Sk9N1mJyQCGGNj01NExx/view) збору даних та імпортуйте

![](media0/1.png)

- [ ] зробіть розгортання потоку, переглядаючи та змінюючи значення змінних за допомогою OPC UA Client UaExpert перевірте, що у глобальному контексті "RTDB" дані оновлюються
- [ ] перегляньте та проаналізуйте вміст потоку

### 4.1. Реєстрація на платформі Ubidots

Обмеження безкоштовної ліцензії описано [тут](https://help.ubidots.com/en/articles/639806-what-is-the-difference-between-ubidots-and-ubidots-stem)

- [ ] Зайдіть на сайт  <https://ubidots.com/manufacturing/>
- [ ] Натисніть "Sing up" або перейдіть [за посиланням](https://industrial.ubidots.com/accounts/signup_industrial/)
- [ ] Натисніть "Take Me To Ubidots Stem"
- [ ] Вкажіть реєстраційні дані та "Sign Up For Free"

### 4.2.Створення та налаштування нового пристрою

- [ ] Зайдите в перечень устройств, там по умолчанию должно быть устройство "Demo", выберите его 

![](media0/28.png)

- [ ] Посмотрите какие настройки можно задать в устройстве:
  - [ ] описание (Description)
  - [ ] маркер доступа (Token)
  - [ ] теги (tags) для фильтрации
  - [ ] тип устройства (для платной лицензии)
  - [ ] размещение (Loaction): вручную или из переменной
  - [ ] определенные пользователем [свойства устройства](https://help.ubidots.com/en/articles/2132945-device-properties)

![](media0/29.png)

- [ ]  Нажмите на переменной "Demo", откройте для просмотра ее настройки
- [ ]  Посмотрите доступные свойства переменной и настройки просмотра 

![](media0/30.png)

### 4.3.Просмотр демонстрационных Dashboard

- [ ] Используя меню "Data" зайдите в Dashboards

### 4.4.Создание и настройка нового устройства

- [ ] Зайдите в раздел "Devices"
- [ ] Нажмите "+" для создания нового устройства
- [ ] В предложенном списке типов выберите "Blank Devices"
- [ ] Дайте имя устройству "Conditioner_1"
- [ ] Укажите расположение соответствующее текущему вашому с помощью "set location"

### 4.5.Создание программы в Node-RED для отправки данных

- [ ] На локальном ПК запустите Node-RED, если он не запущен
- [ ] Установите библиотеку [ubidots-nodered](https://flows.nodered.org/node/ubidots-nodered) после чего перезапустите Node-RED
- [ ] Создайте поток (закладку) с именем "ubidots"
- [ ] Реализуйте в потоке приведенную ниже программу, обратите внимание на то, что в поле `Token` нужно вставить скопированный с одноименного поля в Devices. Обновление поставьте раз/минуту, при частом обновлении быстро закончится дневной лимит точек. Ограничение бесплатной лицензии описано [тут](https://help.ubidots.com/en/articles/639806-what-is-the-difference-between-ubidots-and-ubidots-stem)    

 ![](media0/31.png)  

```js
let cond = global.get ("RTDB.ns=3;s=AirConditioner_1");
let ob = {};
//https://ubidots.com/docs/hw/#introduction
for (const tag in cond){
    ob[tag] = {
        "value":cond[tag].val,
        "timestamp":cond[tag].ts,
        "context": { "key1": "value1", "key2": "value2"}, 
        "created_at": cond[tag].ts
    };
}
msg.payload = ob;
return msg;  
```

- [ ] Сделайте разворачивание потока

### 4.6.Просмотр переменных на платформе 

- [ ] Перейдите на платформу, откройте устройство, обновите страничку, если она была открыта

Вы должны увидеть переменные в виде их текущих значений

- [ ] Используйте кнопку "Toggle View" для изменения формата отображения

![](media0/32.png) 

- [ ] Выберите переменную температуры для ее детального анализа 

![](media0/33.png)

- [ ] Выставите свойства:
  - [ ] масштаба "Allowed range" (0-100)
  - [ ] единицы измерения (°С)
  - [ ] цвет (кликнуть по кисточке)
- [ ] Настройте цвета для остальных переменных  

### 4.7.Создание и настройка Dashboard 

- [ ] Перейдите в Dashboards
- [ ] В левом верхнем углу откройте меню и создайте новый Dashboard с именем "Conditioner1"

![](media0/34.png)

- [ ] Настройте чтобы на Dashboard отображались последние 10 минут информации

### 4.8.Добавление различных виджетов

- [ ] Самостоятельно добавте различные виджеты на  Dashboard с привязкой к разлчиным переменным. Обратите внимание, что некоторые виджеты требуют одной переменной, другие нескольких. Пока  добавляйте следующие виджеты:
  - [ ] HTML Canvas
  - [ ] Manual input
  - [ ] Slider
  - [ ] Switch

![](media0/35.png)

### 4.8.Добавление виджета HTML Canvas

- [ ] Добавьте виджета Canvas [по примеру Simple text with an Image](https://help.ubidots.com/en/articles/754634-html-canvas-widget-examples)

### 4.9.Модификация программы для изменения задания

- [ ] Добавьте фрагмент программы с подпиской на изменение задания по влажности и температуре

![](media0/36.png)

### 4.10.Добавление виджетов для изменения задания

- [ ] Добавьте виджет Manual Input и настройте его на изменение задания заданной и текущей температуры
- [ ] Измените с помощью этого виджета задания на температуру и влажность
- [ ] Проведите такую же операцию с виджетом "Slider"
- [ ] Используйте виджет "Switch" для формирования задания для 2-х уставок температуры, например 15 (ON) и 25 (OFF) градусов   

### 4.11.Генерирование события 

- [ ] Перейдите на страницу настройки событий Data->Events
- [ ] Нажмите "Create Event"
- [ ] Настройте событие на отправку почтового сообщения если температура превышает 60

![](media0/37.png)

- [ ] Установите задание на 65 градусов, после превышения 60 градусов должно прийти сообщение на указанную почту 

### 4.12.Создание доступа  

- [ ] Перейдите в настройки Dashboard и сгенерируйте ссылку для общего доступа

![](media0/38.png)

- [ ] Проверьте что ссылка открывается в другом браузере



https://thingsboard.io/ 