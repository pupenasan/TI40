**Технології індустрії 4.0. Лабораторний практикум. ** Автор і лектор: Олександр Пупена 

| [<- до лаборних робіт](README.md) | [на основну сторінку курсу](../README.md) |
| --------------------------------- | ----------------------------------------- |
|                                   |                                           |

# Лабораторна робота №3. Xмарні сервіси для Індустрії 4.0

# Частина 1. Основи роботи з хмарною платформою IBM Cloud

**Мета**: Освоїти базові функції хмарних платформ на прикладі IBM Cloud. 

Цілі: 

1. створити власний IBM Cloud Account з безкоштовною ліцензією ;
2. створити сервіси: застосунок Node-RED, СУБД Cloudant з використанням стартового набору  “Node-RED starter”; 
3. використати  хмарний застосунок Node-RED разом з СУБД Cloudant для:
- збору даних з Edge, використовуючи один із протоколів, наприклад WEB Socket 
- збереження даних в базі даних
- відображення даних у вигляді тренду  

**Увага, зовнішній вигляд інтерфейсу налаштування IBM Cloud постійно змінюється!** 

**Увага, набір наданих сервісів та політика ліцензування IBM Cloud може змінитися! У будь якому випадку, без використання угоди та реєстрації кредитної картки ніякі кошти за використання стягуватися не можуть.**  

Хмарна платформа IBM об'єднує платформу як послугу (PaaS) з інфраструктурою як послуга (IaaS) для забезпечення інтегрованої взаємодії. Платформа масштабує і підтримує як невеликі команди розробників, так і великі підприємства. 

Хмарна платформа надає доступ до керування хмарними ресурсами. Ресурс - це все, що можна створити, керувати і містити в групі ресурсів. Деякі приклади ресурсів – це програми, екземпляри сервісів, контейнерні кластери, томи зберігання та віртуальні сервери. Детально про платформу IBM Cloud можна прочитати за [цим посиланням](https://cloud.ibm.com/docs/overview/ibm-cloud-platform.html)     

### 1. Створення власного IBM Cloud Account з безкоштовною ліцензією  

Хмарні сервіси платформи IBM Cloud доступні за попередньої реєстрації. Мінімальним тарифним планом, що потребується в цій лабораторній роботі є **Lite**. Реєстрація в тарифному плані Lite потребує тільки адреси електронної пошти, ім’я та прізвища і не потребує кредитної картки. Зареєструвавшись, у Вас буде можливість використовувати певний набір сервісів безкоштовно у означеному обсязі. Обсяг та набір сервісів можуть змінюватися час від часу. Передбачається, що використовувані в лабораторній роботі сервіси використовуються безкоштовно. 

###### 1.1.  Реєстрація аккаунту

Відкрийте в браузері сторінку реєстрації  IBM Cloud [https://cloud.ibm.com/registration](https://cloud.ibm.com/registration) (рис.1)

![](3_1media/1.png)                               

рис.1.

Введіть адресу пошти в поле Email і натисніть Enter. У випадку, якщо на вказану адресу немає зареєстрованого користувача, активуються інші поля для вводу (рис.2). Після вводу усіх полів натисніть «Create Account».

![](3_1media/2.png)  

рис.2.

Якщо усі поля були заповнені вірно, з’явиться вікно на кшталт показаного на рис.3.

![](3_1media/3.png) 

рис.3. 

###### 1.2. Підтвердження аккаунту

 На вказану пошту повинно прийти повідомлення з пропозицією підтвердження (рис.4).

![](3_1media/4.png) 

рис.4.

Для підтвердження аккаунту натисніть «Confirm Account». Після вдалого підтвердження, повинно з’явитися вікно підтвердження (рис.5) з якого можна перейти на сторінку входу натиснувши “Log In”. На цьому реєстрація аккаунту в IBM Cloud вважається завершеною. 

![](3_1media/5.png)  

рис.5.

###### 1.3. Вхід в аккаунт, ознайомлення з інтерфейсом консолі

Скориставшись [посиланням](https://cloud.ibm.com/login) зайдіть в свій аккаунт.

Зовнішній графічний інтерфейс сторінки для адміністрування ресурсами IBM® Cloud називається **консоллю** (IBM® Cloud console). За допомогою консолі можна створювати аккаунти (облікові записи), входити в систему, доступати до документації, доступатися до каталогу, переглядати інформацію про ціни, запитувати підтримку, або перевіряти стан компонентів IBM Cloud. 

Інтерфейс консолі постійно змінюється. На момент створення даної лабораторної роботи він мав вигляд, як на рис.6.

![](3_1media/6.png) 

рис.6.

Огляньте головне меню, яке знаходиться вгорі сторінки. Коли ви входите в систему IBM Cloud, першою сторінкою, яку можна переглянути, є інформаційна панель, на якій відображаються віджети, що узагальнюють інформацію про стан вашого облікового запису. Далі можна керувати своїми ресурсами, перейшовши на піктограму Меню навігації -> Resource List. (рис.7)

![](3_1media/7.png) 

рис.7.

- посилання Catalog (Каталог) використовується для створення нових ресурсів.
- посилання Docs - для доступу до корисної інформації про IBM Cloud.
- посилання Support  (Підтримка) - для доступу до Центру підтримки.
- у меню Manage (керування) можна отримати доступ до облікового запису, виставлення рахунків та використання коштів, а також параметрів керування ідентифікацією та доступом.
- калькулятора витрат використовується для виклику оцінювача витрат.


###### 1.4. Перегляд каталогу

Перейдіть до каталогу. За замовченням там відобразяться тільки ті ресурси, які можна використовувати (добавляти) для Вашого тарифного плану, тобто lite (рис.8). Використовуючи кнопку «filter» можна змінювати налаштування фільтру. 

![](3_1media/8.png) 

рис.8.

###### 1.5. Налаштувань аккаунту

Перейдіть в меню Manage ->Account->Account Settings для перегляду налаштувань свого аккаунту (рис.9).  

![](3_1media/9.png) 

рис.9.



### 2. Створення та адміністрування сервісів з комплекту Node-RED starter  

Стартовий комплект (starter kit) «Node-RED starter» дає можливість легко створити мінімальний сервісів для роботи з Node-RED в хмарі, а саме:

- **застосунок JavaScript**® (Node.js) з виділеною 256 Мб пам’яті , на якому буде встановлений Node-RED
- **Cloudant** - масштабована база даних документів JSON для веб-, мобільних, IoT та безсерверних програм   

###### 2.1. Створення стартового набору Node-RED starter 

Перейдіть в каталог IBM Cloud і виберіть пункт **Starter Kit**. Серед показаних пропозицій виберіть Node-RED Starter (рис.10).  

Перейдіть на вкладку Software(рис.8.1), у “Offering type” виділіть опцію «Starter kits» (рис.8.2) , у переліку доступних сервісів виберіть «Node-RED App» (рис.8.3)   ![](3_1media/10.png)

рис.10.

У наступному вікні натисніть Create app (рис.10а).

![](3_1media/10a.png) 

рис.10а.

Заповніть сторінку аналогічно як на рис.11, вкажіть AppName (1) та Region=London(2).  Зверніть увагу на те, що AppName має бути унікальним, тому для даної лабораторної роботи це поле повинно включати ваше прізвище (наприклад Ivanenko) і ім’я (наприклад Ivan) англійською мовою без пробілів за наступним шаблоном: 

 ivanenkoivannodered

**Також зверніть увагу, що назва повинна включати тільки маленькі літери, інакше при наступному перезавантаженні можуть виникнути проблеми з запуском!** 

Після заповнення натисніть “Create” (рис.11.поз.3)

![](3_1media/11.png)  

рис.11.

Через кілька секунд з’явиться вікно для налаштування новоствореного App, до якого входить сервіс бази даних Cloudant. Він використовуватиметься для збереження налаштувань Node-RED, усіх вузлів та потоків. Для розгортання Node.js та Node-RED можна використати два механізма – через віддалений клієнт або через сервіси керування життєвим циклом DevOPS. Для другого шляху необхідно налаштувати «Configure Continuous Delivery”, натиснути кнопку «Deploy Your App» (рис.11а) 

 ![](3_1media/11a.png)

рис.11а.

Повинно відкритися вікно конфігурування IBM Cloud Foundry (рис.12). У ньому виберіть регіон = London, кількість пам’яті = 256, і згенеруйте «IBM Cloud API key» кнопкою «New». Після цього натисніть на кнопку «Create» в правому верхньому кутку сторінки.   

![](3_1media/12.png) 

рис.12.

Перейдіть на [перелік Ваших ресурсів](https://cloud.ibm.com/resources) . Почекайте кілька хвилин (десь 3-5), періодично оновлюйте сторінку , поки створиться і запуститься Ваш Cloud Foundry apps (рис.13), тобто перейде в стан “Started”.  

![](3_1media/13.png) 

рис.13

###### 2.2. Перегляд станів сервісів набору Node-RED starter 

При розгортанні Node-RED starter kit створилися кілька сервісів і ресурсів:

- хмарний застосунок Node.js з наперед встановленим Node-RED 
- не-SQL СУБД Cloudant, що використовує формат JSON

- Toolchain який забезпечує набором утиліт для проектування, створення коду та розгортання проекту

- Continuous Delivery – DevOps сервіси для автоматичного розгортання застосунків

Крім того, автоматично створюється зв'язок між цими сервісами, що дозволяє вже використовувати СУБД Cloudant в додатках Node-RED. У даному пункті необхідно подивитися стан цих сервісів. Нагадаємо, що перелік всіх доступних сервісів можна знайти через список ресурсів «Меню навігації» -> «Resource List» ([https://cloud.ibm.com/resources](https://cloud.ibm.com/resources)).

Відкрийте вікно списку ресурсів. У Вас повинно бути доступно 6 ресурсів.  Відкрийте кожний ресурс в окремій вкладці браузеру. Усі сервіси мають вкладку Manage, через який ними можна керувати, окрім ресурсу-псевдоніму Cloudant і App. Детальніше пояснення цих ресурсів буде згодом. Наразі розглянемо тільки ресурс  Cloudant  і Node-RED  

###### 2.3. Перегляд стану сервісу Cloudant  

Використовуючи ліву бічну панель передивіться усі закладки ресурсу Cloudant (рис.14). Зокрема подивіться які сервіси підключені до нього в закладці Connections. В звіті поясніть що це за підключення.  

 

![](3_1media/14.png)  

рис.14.

###### 2.4. Перегляд стану та керування виконанням сервісу Node-RED  

Використовуючи ліву бічну панель передивіться усі закладки ресурсу Node-RED (рис.15). 

Зокрема на закладці «Overview» можна подивитися стан сервісу. Наприклад «Stopped» вказує на те, що сервіс зупинено. Слід звернути увагу, що при невикористанні сервісу протягом певного періоду він автоматично зупиняється, про що буде повідомлено листом на пошту, яка використовувалась при реєстрації. Запуск, зупинка та перезапуск сервісу відбувається через праве меню керування сервісом (див. рис.15). 

Якщо сервіс не виконується – запустіть його.

![](3_1media/15.png) 

рис.15.

Перейдіть на закладку бічної панелі Runtime. Передивіться зміст усіх можливостей: Memory and Instance, Environment variables та SSH. Зверніть увагу, що SSH дає можливість керувати контейнером Node.js (рис.16).  

![](3_1media/16.png) 

рис.16. 

Передивіться вміст інших вікон налаштувань переходячи на усі інші закладки бічної панелі. 

###  3. Перший запуск і робота з хмарним сервісом Node-RED  

Робота з хмарним застосунком Node-RED аналогічна як і з локальним. Слід зазначити, що в ньому вже інтегровано багато функцій, які стосуються роботи з хмарними сервісами IBM Cloud, що робить його зручним і простим інструментом інтеграції застосунків IIoT та Industry 4.0. У даному підрозділі показано як перший раз запускати сервіс Node-RED, та як створити простий розподілений додаток Node-RED local <-> Node-RED Clud. 

У першій лабораторній роботі була наведена одна із структур рішень IIoT (рис.16.а). В даній частині лабораторної роботи пропонується використовувати зв'язок Node-RED з боку Edge (наприклад на базі Raspberry PI) та хмарного застосунку Node-RED з використанням протоколу WEB Socket.   

![](3_1media/16a.png) 

рис.16.а

###### 3.1. Перший запуск Node-RED  

На вкладці Overview керування ресурсами Node-RED, натисніть «Visit App Url» (див.рис.16). Почекайте хвилинку, поки завантажиться сторінка. Якщо вона не завантажується повторіть пункт знову.

При першому вході в систему, необхідно пройти процедуру налаштування. Це потрібно для створення користувача, що зможе розробляти додатки Node-RED. 

На сторінці привітання рис.17, натисніть “Next”.  Вкажіть ім’я та пароль користувача, які зможуть редагувати застосунки в Node-RED (рис.17) також обов’язково виставить опцію «Allow anyone to view the editor» і натисніть “Next”.     

![](3_1media/17.png) 

рис.17.

Використовуючи кнопку “Next” перейдіть до останньої вкладки і натисніть “Finish”.  На стартовому вікні Node-RED (рис.18) натисніть кнопку “Go to your Node-RED flow editor”.

![](3_1media/18.png) 

рис.18.

 

###### 3.2. Інсталяція Node-RED  

Через зображення користувача зайдіть під своїм користувачем і паролем, які Ви налаштували до цього (18а). 

![](3_1media/18a.png) 

рис.18.а

Використовуючи меню Manage Palette встановіть пакет node-red-dashboard. Тепер у Вас є можливість розробляти користувацький інтерфейс для загального доступу з Інтернету.

###### 3.3. Перевірка доступу до користувацького інтерфейсу Node-RED  

Створіть просту програму, яка виводить текст отриманий з вузла Inject (рис.19). Налаштуйте одну закладку та групу для Веб-інтерфейсу, зробіть розгортання проекту. Відкрийте інтерфейс користувача. 

Скопіюйте посилання на сторінку Вашого інтерфейсу, відкрийте його на іншому ПК, смартфоні або, якщо такої можливості немає – в іншому браузері. 

Якщо інтерфейс відображається, це значить що тепер є можливість розробляти графічний інтерфейс IoT для загального доступу.  

![](3_1media/19.png) 

рис.19.

###### 3.4. Передача даних з локального Node-RED на віддалений з використанням WEB-socket  

Модифікуйте програму в хмарному Node-RED, як це показано на рис.20.

![](3_1media/20.png) 

рис.20.

Запустіть Node-RED на локальному ПК. Створіть новий потік з назвою «Laba3_1», всі інші потоки деактивуйте. Створіть програму, яка показана на рис.21. При цьому першу частину шляху (яка замальована на рис.21) скопіюйте з Вашого хмарного UI. 

![](3_1media/21.png) 

рис.21.

  Зробіть розгортання на локальному і віддаленому Node-RED. Активуючи Inject на локальному ПК перевірте роботу зв’язку між локальним та хмарним застосунком Node-RED.

Модифікуйте програму в локальному Node-RED, як це показано на рис.21.а. Ця програма імітує змінні **ramp** та **sin** кожні 5 секунд. Перевірте її роботу.

 ![](3_1media/21a.png)

рис.21.a. 

**Використовуючи усі розглянуті в минулій лабораторній роботі протоколи можна інтегрувати сервіси хмарного** **Node-RED як з** **Edge так і з іншими хмарними сервісами чи застосунками Інтернету. Таким чином, хмарний** **Node-RED можна використовувати в якості основного сервісу, що забезпечує з’єднання між** **Edge та іншими сервісами.** 

Тим не менше в наступній частині лабораторної роботи в якості базового сервісу IIoT буде використовуватися IBM Internet of Things Platform.

###  4. Перший запуск і робота з хмарним сервісом Cloudant  

[IBM Cloudant](https://console.bluemix.net/docs/services/Cloudant/api/database.html#databases) - це документно-орієнтована база даних як служба (DBaaS). Вона зберігає дані у вигляді документів формату JSON. 

###### 4.1. Запуск сторінки адміністрування Cloudant (Cloudant Dashboard)    

Використовуючи список ресурсів перейдіть на вікно керування сервісом Cloudant (**Cloudant Dashboard**). У вікні Manage, натисніть “Launch Cloudant Dashboard” для запуску сторінки адміністрування сервісу.  

![](3_1media/22.png) 

рис.22.

###### 4.2. Вікна налаштування та адміністрування Cloudant    

Після запуску вікна адміністрування Cloudant, автоматично відкриється вкладка Databases (рис.23). На цій вкладці видно всі бази даних (документи)  Cloudant. Після першого запуску Cloudant в переліку буде тільки база даних nodered.  

![](3_1media/23.png) 

рис.23.

   Передивіться усі сторінки зі вкладок лівої бічної панелі (рис.23). Зокрема подивіться на обмеження підписки на вкладці Account.

###### 4.3. Створення БД    

На вкладці Databases натисніть кнопку «Create Database». Назвіть цю БД «db1».  У виборі типу вкажіть "Non-partitioned". 

 ![](3_1media/24.png)

рис.24.

###### 4.4. Запис в БД з хмарного Node-RED    

У даному пункті для запису отриманих даних з пристрою Edge використовуватимуться вузли Cloudant.  

Ознайомтеся з роботою вузлів Cloudant [довідника](https://pupenasan.github.io/NodeREDGuidUKR/storage_cloudant/) Node-RED.

Змініть програму у хмарному Node-RED, як це показано на рис.25. 

 ![](3_1media/25.png)

рис.25.

Зробіть розгортання проекту і запустіть на виконання. Перевірте чи пишуться дані в БД. Запустіть Cloudant Dashboard. В переліку БД зайдіть в базу даних “db1”, натисніть її для перегляду. У списку документів повинні з’явитися записи, як на рис. 26. 

![](3_1media/26.png) 

рис.26.

###### 4.5. Перегляд БД з Cloudant Dashboard    

У списку документів виберіть табличне представлення (кнопка Table). Як видно дані відображаються у вигляді таблиці, я якій є поля _id, ramp та sin (рис.27).  

![](3_1media/27.png) 

рис.27. 

Перегляньте перелік у вигляді списку документів JSON (рис.28). Намагайтеся розібратися в структурі документу.  Детальний опис структури документу наведений за [цим](https://console.bluemix.net/docs/services/Cloudant/api/document.html#documents) і за [цим](https://console.bluemix.net/docs/services/Cloudant/api/design_documents.html#design-documents) посиланням.  Нижче описані тільки деякі основні поля.

Усі документи повинні мати унікальні поля  `_id` та `_rev`. Поле `_id` може формуватися автоматично. Поле `_rev` є номером версії. Окрім цих 2-х полів, документ може вміщувати будь які інші поля, відповідно до правил JSON. Поля, що починаються з «_» зарезервовані як службові. 

 

![](3_1media/28.png) 

рис.28.

###### 4.6. Читання записів даних БД Cloudant з Node-RED    

Вставте в хмарному Node-RED вузол Cloudant in і модифікуйте програму, як це показані на рис.29.  

Зробіть розгортання проекту і перевірте його роботу. У вікні відлагодження після запуску Inject повинен сформуватися масив документів за весь час роботи. 

 ![](3_1media/29.png)

 рис.29.

###### 4.7. Добавлення в документи відмітки часу    

Для того, щоб мати можливість заходити дані за часом, необхідно в записи вставляти також відмітки часу. Модифікуйте локальну програму в Node-RED так, як це показано на рис.30.

![](3_1media/30.png)  

рис.30

Зробіть розгортання та перевірте його роботу.

###### 4.8. Формування та перевірка користувацьких запитів find в Cloudant Dashboard    

Для доступу до документів (а також для створення, видалення, модифікації) БД Cloudant використовується HTTP API. Як і всі СУБД, Cloudant приймає запити від клієнтів і повертає відповідь на них. 

- Для доступу до необхідного документу необхідно вказати його  [_id](https://console.bluemix.net/docs/services/Cloudant/api/document.html#documents). Це можна зробити, використовуючи запит GET:


```
https://$ACCOUNT.cloudant.com/$DATABASE/$DOCUMENT_ID
```

- Якщо ідентифікатор невідомий можна прочитати усі документи з бази даних задавши параметр [_all_docs](https://console.bluemix.net/docs/services/Cloudant/api/database.html#get-documents) 


```
https://$ACCOUNT.cloudant.com/$DATABASE/_all_docs
```

Саме такий механізм використовується в вузлі Cloudant in в Node-RED  в п.6. 

- Крім цього, IBM Cloudant підтримує пошук документів по індексам з використанням методу POST та параметру [_find](https://console.bluemix.net/docs/services/Cloudant/api/cloudant_query.html#finding-documents-by-using-an-index) . 


```
https://$ACCOUNT.cloudant.com/$DATABASE/_find
```

- Ще одним механізмом доступу до документів є використання пошукового індексу ([search indexes](https://console.bluemix.net/docs/services/Cloudant/api/search.html#search)). 


```
https://$ACCOUNT.cloudant.com/$DATABASE/_design/$DDOC/_search/$INDEX_NAME
```

Для перевірки користувацьких запитів з використанням параметру [_find](https://console.bluemix.net/docs/services/Cloudant/api/cloudant_query.html#finding-documents-by-using-an-index) можна скористатися вбудованим редактором запитів Query. З сторінки Cloudant Dashboard зайдіть в db1. Відкрийте Query і введіть запит, як на рис.31. і натисніть “RUN QUERY”. В результаті повинен буде виданий результат запиту.  

![](3_1media/31.png) 

рис.31 

###### 4.9. Створення пошукових індексів в Cloudant    

Вузол Node-RED “cloudant in” не вміє формувати запити з параметром «find» (але є бібліотеки з вузлами, які вміють), замість цього можна користуватися відбором за пошуковим індексом, який необхідно попередньо створити. У пошуковому індексі необхідно вказати перелік усіх полів, за яким відбувається пошук. У нашому випадку – це поле «ts», за яким необхідно робити вибірку документів з БД.

Детальний опис призначення і порядку створення пошукових індексів наведений на [сторінці допомоги](https://console.bluemix.net/docs/services/Cloudant/api/search.html#search).

На сторінці БД db1 створіть новий Search index, як це показано на рис.32. Натисніть “Search Document and Build Index”.

![](3_1media/32.png)   

рис.32

###### 4.10. Формування користувацьких запитів  в Node-RED    

Модифікуйте програму в в хмарному Node-RED, як це показані на рис.33. Зверніть увагу на пробіли! 

Зробіть розгортання проекту і перевірте його роботу. У вікні відлагодження після запуску Inject повинен сформуватися масив документів за останні 5 хвилин роботи (60 записів). 

 ![](3_1media/33.png)

рис.33

###### 4.11. Перегляд відібраних даних в Node-RED за допомогою трендів    

Історичні дані, що записані в Cloudant можна відобразити з використанням Dashboard. Модифікуйте програму, як це показано на рис.34, нижче наведений лістинг функції “->Trend”, яку можне скопіювати для пришвидшення розробки. Зробіть розгортання проекту і перевірте його роботу. Відкрийте Веб-інтерфейс і перевірте, там повинні відображатися дані за останні 5 хвилин.

```javascript
var result = msg.payload;
var chart = [{
    "series":["ramp","sin"],
    "data":[],
    "labels":[""]
}];
chart[0].data[0]=[];
chart[0].data[1]=[];
for (var i = 0; i < result.length; i++) {
    chart[0].data[0][i] = {"x":result[i].ts,"y":result[i].ramp};
    chart[0].data[1][i] = {"x":result[i].ts,"y":result[i].sin};
}
msg.payload = chart;
return msg;

```

![](3_1media/34.png)  

рис.34

**Скопіюйте адресу вашої Веб сторінки і відправте її викладачу, це буде звітом до Вашої роботи.** 

Необов’язкове завдання для самостійного виконання.

###### 4.12. Перегляд даних за вказаний інтервал    

Спробуйте модифікувати програму в хмарному Node-RED так, щоб в користувацькому інтерфейсі вводився початковий час відображення тренду і була можливість змінювати глибину відображення. 



## Додаток 1. Node-RED IBM Cloud Starter Application  

[https://github.com/ibmets/node-red-bluemix-starter](https://github.com/ibmets/node-red-bluemix-starter)

[https://github.com/knolleary/node-red-bluemix-starter](https://github.com/knolleary/node-red-bluemix-starter ) 

### Node-RED IBM Cloud Starter Application

### Як працює розгортання за однією кнопкою?

Коли ви натискаєте кнопку, ви перейдете до IBM Cloud, де ви отримаєте назву для вашої програми, після чого платформа захопить код з цього сховища і отримає його розгортання.

Вона автоматично створить примірник служби Cloudant і прив'яже її до вашого додатка. Тут ваш екземпляр Node-RED буде зберігати свої дані.

Під час першого доступу до програми вам буде запропоновано встановити деякі параметри безпеки, щоб забезпечити безпеку вашого редактора потоків від несанкціонованого доступу.

Вона включає в себе набір потоків за замовчуванням, які автоматично розгортаються при першому запуску Node-Red

### Customising Node-RED

Цей репозиторій тут буде клонований, змінений і повторно використаний для того, щоб дозволити будь-якому користувачеві створити власне Node-RED-додаток, яке можна швидко розгорнути в IBM Cloud.

Потоки за замовчуванням зберігаються в каталозі `defaults` у файлі з назвою `flow.json`. Коли застосунок вперше запущений, цей потік копіюється до приєднаного екземпляру Cloudant. Коли зміна розгортається з редактора, буде оновлена версія в cloudant – але не цей файл.

Веб-вміст, який ви отримуєте під час переходу до URL-адреси програми, зберігається в каталозі `public`.

До файлу `package.json` можна додати додаткові вузли, а всі інші налаштування конфігурації Node-RED можна встановити в `bluemix-settings.js`.

Якщо ви клонуєте це сховище, переконайтеся, що ви оновили цей файл `README.md`, щоб вказати кнопку `Deploy to IBM Cloud` у вашому репозиторії.

Якщо ви хочете змінити назву створеного екземпляра Cloudant, пам'ять виділена застосунку  або інші параметри часу розгортання, подивіться в `manifest.yml`



# Частина 2. Хмарні сервіси для збереження об’єктів

**Мета**: Навчитись користуватися функціями хмарних сервісів збереження даних та отримати базові навики адміністрування доступу до хмарних ресурсів. 

Цілі: 

1. визначити функції та налаштування доступу до хмарних ресурсів; 
2. створити та використати власне хмарне сховище:

- створити IBM Cloud Object Storage
- забезпечити доступ до IBM Cloud Object Storage зі сторони Інтернету;
- зробити застосунок для отримання файлів з IBM Cloud Object Storage;

Зовнішній вигляд інтерфейсу налаштування IBM Cloud постійно змінюється! Увага, набір наданих сервісів та політика ліцензування IBM Cloud може змінитися. У будь якому випадку, без використання угоди та реєстрації кредитної картки ніякі кошти за використання стягуватися не можуть.  

## 1. Робота з IBM Cloud Identity and Access Management  

[IBM Cloud Identity and Access Management](https://cloud.ibm.com/docs/iam/index.html#iamoverview) (**IAM**) – дозволяє надійно аутентифікувати користувачів для доступу до ресурсів IBM Cloud. З точки зору доступу, ресурси можна групувати ([resource groups](https://cloud.ibm.com/docs/account/resourcegroups.html)), що дозволяє надавати користувачам швидкий і легкий доступ до більш ніж одного ресурсу одночасно. Політика доступу до хмари IAM використовується для назначення доступу до ресурсів облікового запису як користувачам (users) так і сервісам (через Service ID). Можна групувати користувачів і Service ID в групи доступу ([access group](https://cloud.ibm.com/docs/iam/groups.html)), щоб легко надати всім особам у групі однаковий рівень доступу.

Модель функціонування IAM показана на рис.1.  Для сервісів, які не підтримують створення політик Cloud IAM для керування доступом, можна скористатися [доступом до Cloud Foundry](https://cloud.ibm.com/docs/iam/cfaccess.html#cfaccess) або [доступом до класичної інфраструктури](https://cloud.ibm.com/docs/iam/infrastructureaccess.html#infrapermission).

![](3_2media/1.png)                               

рис.1.

Уніфіковане керування користувачами дозволяє додавати або видаляти користувачів облікового запису як для сервісів платформи (керування, адміністрування), так і для класичних сервісів інфраструктури. 

Доступ для користувачів, service IDs і груп доступу означується **політикою** (**policy**). В межах політики, область доступу для користувача, service ID або група доступу може бути назначена набору ресурсів у групі ресурсів, єдиному ресурсу або сервісам керування обліковим записом. Після встановлення області дії, вибравши ролі доступу можна визначити, які дії дозволяється суб'єктом вказаної політики. Ролі надають можливість адаптувати рівень доступу, наданий суб'єкту політики (subject of the policy) для виконання дій на цілі політики.

Для користувача можуть бути створені декілька ключів API (API keys). Той же ключ можна використовувати для доступу до декількох сервісів. Ключі IBM Cloud API дозволяють користувачам, які використовують двофакторну аутентифікацію або федеративний ідентифікатор (federated ID), автоматизувати аутентифікацію консолі з командного рядка. Користувач може також мати один класичний інфраструктурний ключ API, який можна використовувати для доступу до класичних інфраструктурних API; однак, це не є обов'язковим, оскільки можна використовувати ключі IBM Cloud API для доступу до тих самих API.

Ідентифікатор сервісу (**Service ID**) ідентифікує сервіс або застосунок, якому необхідно надати доступ до ресурсу. Ідентифікатор користувача (**user ID**) ідентифікує користувача, тобто людину, якій необхідно надати доступ до ресурсу. Це ідентифікатори, які можуть використовуватися застосунками для автентифікації за допомогою сервісу IBM Cloud. Кожному Service ID можна призначити правила, щоб керувати рівнем доступу, дозволеним застосунком, який використовує цей ідентифікатор сервісу. Крім того можна створити API key, щоб активувати автентифікацію.

Для адміністрування Cloud IAM використовуючи консоль можна перейти за посиланням **Manage** > **Access (IAM)**.

###### 1.1. Перегляд вікон налаштування  IAM для користувачів  

Перейдіть до вікон налаштування IAM **Manage** > **Access (IAM)**. (рис.2) . 

![](3_2media/2.png) 

рис.2.

Перейдіть на вкладку Users. Відкрийте налаштування користувача через пункт Manage user details (рис.3).

![](3_2media/3.png) 

рис.3.

Передивіться зміст усіх закладок User details, Access groups, Access policies.

###### 1.2. Перегляд вікон налаштування  IAM для Service ID  

Перейдіть до вкладки ServiceIDs (рис.4) . Для вашого аккаунту повинен бути автоматично створений як мінімум один Service ID, який можна налаштувати. Також це вікно дає можливість створювати нові Service ID та редагувати існуючі. Для того щоб передивитися деталі для даного ServiceID перейдіть на його налаштування, клікнувши за посиланням в полі Name, або клікнувши по Manage service ID в контекстному меню. З опису (Description) видно, що даний ServiceIDs був створений для доступу до Cloudant.  

![](3_2media/4.png) 

рис.4.

## 2. Створення, наповнення та адміністрування IBM Cloud Object Storage  

[IBM Cloud Object Storage](https://console.bluemix.net/docs/services/cloud-object-storage/about-cos.html#about-ibm-cloud-object-storage) (надалі, **COS**) - це хмарне сховище даних, яке за своїми функціями подібне до файлового серверу). [Глосарій термінів](https://cloud.ibm.com/docs/overview?topic=overview-glossary).

###### 2.1. Створення  IBM Cloud Object Storage 

Відкрийте IBM Cloud і увійдіть в систему. Перейдіть [на вкладку з ресурсами](https://cloud.ibm.com/resources) і натисніть на Object Storage (рис.5). 

![](3_2media/5.png)  

Рис.5.

​      У вікні налаштувань створення сервісу (рис.6) вкажіть ServiceName, відповідно до вашого прізвища та імені, наприклад для Іваненко Івана згідно та шаблону:

```
IvanenkoIvanStorageCOS
```

![](3_2media/6.png) 

Рис.6. 

###### 2.2. Створення  Bucket 

Після створення сервісу, автоматично відкриється вікно швидкого старту (рис.7), де запропонують створити Bucket (буквальний переклад «Відро»).  **Bucket** – це розділ для сховища об’єктів, який за своїми функціями схожий на папку, в якій зберігаються файли. З цієї точки зору об’єкти також в певному наближенні можна вважати файлами. Новий Bucket також можна створювати з розділу Buckets. 

![](3_2media/7.png) 

Рис.7.

Натисніть кнопку “Create Bucket” для створення нового  Bucket (рис.8). Вкажіть Bucket Name, відповідно до вашого прізвища та імені, наприклад для Іваненко Івана згідно та шаблону:

```
ivanenko-ivan-files
```

![](3_2media/8.png) 

Рис.8.

Дочекайтеся, поки буде створений Bucket, після чого ви отримаєте повідомлення і автоматично перейдете до вкладки Objects (рис.9).

![](3_2media/9.png) 

Рис.9.

###### 2.3. Добавлення файлів в Bucket.

За допомогою кнопки `Upload -> Files` (у спливаючому вікні виберіть Standard Upload), або шляхом перетягування, добавте в новостворений Bucket якийсь файл *.jpg (наприклад своє фото). Після завантаження у переліку буде показаний завантажений файл (рис.10).

![](3_2media/10.png) 

Рис10.

###### 2.4. Налаштування доступу до об’єктів Bucket.

Об’єктами COS можна користуватися як з сервісів IBM Cloud, так і поза ними. Для того, щоб мати можливість користуватися цими об’єктами поза межами IBM Cloud (через HTTP API) необхідно налаштувати доступ. Нижче наведені деякі поняття, які необхідні для розуміння. 

[Service credential](https://cloud.ibm.com/docs/overview?topic=overview-glossary#x8878996) (**облікові дані**) - це сукупність важливої інформації, яку розробники використовують для підключення до екземпляра об'єкта зберігання даних. 

[Resource instance ID / Service instance ID](https://console.bluemix.net/docs/services/cloud-object-storage/basics/glossary.html#resource-instance-id-service-instance-id) - коли створюється або надається екземпляр сервісу, йому присвоюється унікальний ідентифікатор у вигляді імені ресурсу хмари (**CRN** - Cloud Resource Name).

[Identity endpoint](https://console.bluemix.net/docs/services/cloud-object-storage/basics/glossary.html#identity-endpoint) – кінцева точка IAM (`iam.bluemix.net`), що використовується для отримання маркера доступу (**access token**) в обмін на ключ API (API key). Цей маркер надалі використовується в заголовку авторизації (`Authorization`) всіх запитів REST API, надісланих кінцевій точці служби зберігання об'єктів.

[Service endpoints](https://console.bluemix.net/docs/services/cloud-object-storage/basics/glossary.html#service-endpoints) (наприклад, `s3.us-south.objectstorage.softlayer.net`) – це базові URLs куди надсилаються запити API, які взаємодіють з даними. 

[Object Storage bucket location](https://console.bluemix.net/docs/services/cloud-object-storage/basics/glossary.html#object-storage-bucket-location) – всі buckets в Object Storage находяться в певному місці. Це або регіон (такий як `us-south` або `us-east`) або географічне місце (такі як `eu-geo` або `us-geo`). У цьому місцезнаходженні об'єкти поділені та розподілені по трьох різних фізичних розташуваннях.

[Regions](https://console.bluemix.net/docs/services/cloud-object-storage/basics/glossary.html#regions). Регіон і розташування часто використовуються як взаємозамінні, але на відміну від більшості сервісів, доступних в IBM Cloud Platform, сховище об'єктів - це "глобальна" служба. IBM Cloud Platform існує в різних регіонах (наприклад, в `US South`` або ``United Kingdom`), а деякі сервіси - у місці їх створення. Хоча кожен екземпляр сховища об'єктів вважається "глобальним", кожен окремий bucket має певну комбінацію розташування, стійкості та класу зберігання.

Як наведено вище, для доступу інших сервісів до ресурсів IBM cloud, необхідно створити Service ID, у якому назначити права доступу до конкретних ресурсів через ролі. Потім в межах цього Service ID необхідно вказати  API key. Далі, будь який сервіс в Інтернеті, щоб скористатися цим ресурсом, повинен доступитися до кінцевої точки ідентифікації (Identity endpoint) з вказівкою API key, щоб отримати маркер доступу (access token). Маючи цей маркер, Інтернет-сервіс звертається до Service endpoints, на якому безпосередньо і знаходиться цільовий ресурс. 

Для того щоб всю необхідну інформацію для доступу надати розробнику в одному місці в IBM Cloud існує можливість створити JSON-файл з обліковими даними (Service credential), використовуючи помічника, якому треба вказувати потрібні вже створені ключі та ідентифікатори. Однак, можна піти зворотнім шляхом, одразу запустивши помічник створення Service credential, який автоматично створить необхідні ключі та ідентифікатори.

Зайдіть в налаштування Service credentials (рис.11). 

 ![](3_2media/11.png) 

Рис11.

Натисніть кнопку «New credential», у новому вікні введіть назву подібну до вказану на рис.12. Також виставте опцію “Include HMAC Credential”. Усі інші поля залиште без змін. 

![](3_2media/12.png) 

Рис12.

---

**Редакція 2020 року**

У випадку, якщо вибір опції “Include HMAC Credential” не з'являється, необхідно створити ключ через   командний рядок та консольний клієнт `ibmcloud`, для цього виконайте наступні команди:

- завнтажте та встановіть консольну утиліту `ibmcloud` https://github.com/IBM-Cloud/ibm-cloud-cli-release/releases/
- відкрийте на комп'ютері консоль командного рядка (`cmd`)
- зареєструйтеся в системі через команду login

```bash
ibmcloud login
```

- введіть почтову скриньку та пароль, які використовуються для доступу до хмарної платформи IBM Cloud  

- копіюйте в консоль вказаний нижче фрагмент та замініть там `cloud-object-storage-lz` на назву вашого екземпляра COS

```bash
ibmcloud resource service-key-create service-credentioal-cos-1 Writer --instance-name cloud-object-storage-lz --parameters "{\"HMAC\":true}"   
```

---

Повинен створитися файл з обліковими даними (рис.13), та всі супутні записи. Вони знадобляться Вам для налаштування клієнтських сервісів, що будуть доступатися до ресурсів.

![](3_2media/13.png) 

Рис13.

###### 2.5. Перегляд створеного Service ID.

Після виконання попереднього пункту, в IBM Cloud повинен автоматично створитися Service ID.  Перейдіть до вікон налаштування IAM Manage > Access (IAM).  Знайдіть в налаштування новоствореного Service ID (Manage Service ID). Новостворений запис можна визначити за датою. Зайдіть на вкладку Access policies, на ній повинен бути запис з роллю Writer (рис.14).

![](3_2media/14.png)

 Рис14.

​        Виберіть пункт контекстного меню Edit, для переходу до редагування ролі. У вікні налаштування ролі видно до яких об’єктів і який доступ надається даною роллю (рис.15). У полі Service Instance вказується ідентифікатор екземпляру COS, тоді як в полях типу і ідентифікатору ресурсу вказується конкретний ресурс, якого стосується дана роль. Якщо ресурс не вказується, то роль стосується доступу до всіх ресурсів екземпляру сервісу. Іншими словами, сервіс, який буде доступатися через цей Service ID в даному випадку буде мати можливість читання/запису в будь якому bucket даного екземпляру COS. На даний момент залиште поля в тому стані, в якому вони є.

![](3_2media/15.png) 

Рис15.

## 3. Використання об’єктів IBM COS в Node-RED  

Доступ до об’єктів COS надається через HTTP API, з яким можна ознайомитися за [посиланням](https://console.bluemix.net/docs/services/cloud-object-storage/api-reference/about-api.html#about-the-ibm-cloud-object-storage-api). У Node-RED є бібліотеки, які вже надають доступ до певних сервісів без необхідності складного програмування, що дає можливість використовувати COS для збереження файлів з наступним їх використанням в застосунках IIoT.  

###### 3.1. Інсталяція пакету  node-red-contrib-cos 

Запустіть сервіс Node-RED  в IBM Cloud, перейдіть в редактор свого застосунку. Через менеджер палітри встановіть модуль `node-red-contrib-cos`. 

###### 3.2. Налаштування конфігураційного об’єкту з COS 

Створіть новий потік. Розмістіть на ньому взол `cos get`. У налаштуваннях `Storage configuration` зайдіть в редагування конфігураційного вузлу (`Add new cos-config...`) Cloud Object Storage.

Відкрийте в іншому вікні перегляд Service credentials для вашого екземпляра COS, який ви створювали в попередніх пунктах. Натисніть  кнопку «View credentials» (див. рис.13)

Скопіюйте необхідні поля з JSON файлу в налаштування вузла, як це показано на рис.16. Зверніть увагу на поле Location, там повинно бути те саме розташування, що і для Bucket. В поле ім’я впишіть “MyCOS”.  Натисніть «Update» для збереження конфігурації.  

![](3_2media/16.png) 

рис.16.

###### 3.3. Отримання переліку об’єктів з COS 

Ознайомтеся з принципами роботи вузлів з «cos get» та «cos query» з  [довідника Node-RED](https://pupenasan.github.io/NodeREDGuidUKR/storage_cos/). У новоствореному потоці розмістіть вузли так, як це показано на рис.17. Зробіть розгортання проекту. 

![](3_2media/17.png)  

рис.17.

​        Ініціюйте отримання переліку Bucket. У випадку вдалого отримання на панелі відлагодження Ви повинні побачити цей перелік. Якщо є помилка, перевірте правильність виконання усіх попередніх пунктів. 

###### 3.4. Отримання об’єкту з COS 

Ініціюйте отримання вказаного у вузлі GET об’єкту, у випадку вдалого отримання на панелі відлагодження Ви повинні побачити цей об’єкт у msg.payload у вигляді масиву. Якщо є помилка, перевірте правильність виконання усіх попередніх пунктів. 

###### 3.5. Ініціювання отримання об’єкту з COS через WEB-запит 

У даному пункті лабораторної роботи необхідно забезпечити ініціювання зчитування об’єктів через веб-запит. Запит повинен проводитися за шаблоном

```
host/files/file_name
```

 де host вказує на розміщення веб ресурсу Node-RED, а file_name – ім’я файлу, який необхідно отримати. У випадку позитивної відповіді необхідно вивести «Об’єкт отримано», у випадку негативної – «Об’єкт не вдалося отримати».

Модифікуйте програму, як це показано на рис.18.

![](3_2media/18.png) 

рис.18.

​        Зробіть розгортання проекту, в новому вікні браузеру, впишіть URL, відповідно до рис.19, з вказівкою існуючого в COS файлі. На сторінці повинно відобразитися повідомлення «Об’єкт отримано». Після цього впишіть назву файлу, якого в COS немає – повинні отримати напис «Об’єкт не вдалося отримати» 

 ![](3_2media/19.png)

рис.19.

Видаліть з програми вузла «Відповідь» рядок 

```
msg.payload = "Об'єкт отримано";
```

Зробіть розгортання проекту. Знову задайте в рядку URL файл, який необхідно вибрати з COS. Замість повідомлення про успішне отримання файлу, він буде зберігатися на локальному ПК.

###### 3.6. Використання файлів COS в наповненні власної сторінки 

В даному пункті COS буде використовуватися в якості сховища медіа-даних для відображення на власній Веб-сторінці. Це знадобиться в наступних лабораторних роботах для формування контексту цифрового двійника в хмарі. 

Завантажте у свій COS файл [за посиланням](https://drive.google.com/open?id=10XoU9xieZSx0GixcPa1HtK4CPx7SVXe9).

Добавте в програму Node-RED фрагмент, показаний на рис.20.  Код у верхньому вузлі Template має мати наступний зміст (необхідно замінити `Ivanenkoivannodered`):

```html
<iframe id="vs_iframe" src="https://www.viewstl.com/?embedded&url=https://Ivanenkoivannodered.eu-gb.mybluemix.net/files/Dragon.stl" style="border:0;margin:0;width:100%;height:100%;"></iframe>
```

![](3_2media/20.png)

рис.20.

​        Зробіть розгортання проекту, відкрийте власну Веб-сторінку, вона повинна мати вигляд, подібний до наведеної на рис.21.

![](3_2media/21.png)  

рис.21.

**Зробіть копію екрану та разом з посиланням на сторінку відправте у звіті.**

# Питання до захисту 

1. Які типи хмарних     платформ Вам відомі? Який тип використовувався в даній лабораторній     роботі?
2. Які хмарні сервіси були     використані в цій лабораторній роботі?
3. Розкажіть про сервіс     Cloudant.
4. Для чого     використовувався Cloudant у даній лабораторній роботі?
5. Розкажіть про     використання користувацьких запитів до Cloudant.
6. Розкажіть про створення     пошукових індексів у Cloudant.
7. Розкажіть про     налаштування вузлів Node-RED для роботи з Cloudant.
8. Розкажіть про основи     IBM Cloud Identity and Access Management.
9. Розкажіть про     призначення та налаштування сервісу COS.
10. Розкажіть про     налаштування доступу до об’єктів Bucket.
11. Розкажіть про     налаштування вузлів Node-RED для роботи з COS.

 